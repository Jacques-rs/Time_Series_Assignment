---
# IMPORTANT: Change settings here, but DO NOT change the spacing.
# Remove comments and add values where applicable.
# The descriptions below should be self-explanatory

title: "Time Series Research Assignment"
subtitle: "A Replication: Estimation of the Equilibrium Real Exchange Rate for South Africa [@mainpaper]"

documentclass: "elsarticle"

# --------- Thesis title (Optional - set to FALSE by default).
# You can move the details below around as you please.
Thesis_FP: FALSE
# Entry1: "An unbelievable study with a title spanning multiple lines."
# Entry2: "\\textbf{Nico Katzke}" # textbf for bold
# Entry3: "A thesis submitted toward the degree of Doctor of Philosophy"
# Uni_Logo: Tex/Logo.png # Place a logo in the indicated location (from your root, e.g. defaults to ~/Tex/Logo.png) and uncomment this line. Leave uncommented for no image
# Logo_width: 0.3 # If using a logo - use this to set width (size) of image
# Entry4: "Under the supervision of: \\vfill Prof. Joe Smith and Dr. Frank Smith"
# Entry5: "Stellenbosch University"
# Entry6: April 2020
# Entry7:
# Entry8:

# --------- Front Page
# Comment: ----- Follow this pattern for up to 5 authors
AddTitle: TRUE # Use FALSE when submitting to peer reviewed platform. This will remove author names.
Author1: "Jacques Rossouw - 21159793"  # First Author - note the thanks message displayed as an italic footnote of first page.
Ref1: "Stellenbosch, Western Cape, South Africa" # First Author's Affiliation
Email1: "gerardrossouw\\@gmail.com" # First Author's Email address

# Author2: "John Smith"
# Ref2: "Some other Institution, Cape Town, South Africa"
# Email2: "John\\@gmail.com"
# CommonAffiliation_12: TRUE # If Author 1 and 2 have a common affiliation. Works with _13, _23, etc.
# 
# Author3: "John Doe"
# Email3: "Joe\\@gmail.com"
# 
# CorrespAuthor_1: TRUE  # If corresponding author is author 3, e.g., use CorrespAuthor_3: TRUE
# 
# # Comment out below to remove both. JEL Codes only given if keywords also given.
# keywords: "Multivariate GARCH \\sep Kalman Filter \\sep Copula" # Use \\sep to separate
# JELCodes: "L250 \\sep L100"

# ----- Manage headers and footers:
#BottomLFooter: $Title$
#BottomCFooter:
#TopLHeader: \leftmark # Adds section name at topleft. Remove comment to add it.
# BottomRFooter: "\\footnotesize Page \\thepage" # Add a '#' before this line to remove footer.
addtoprule: TRUE
# addfootrule: TRUE               # Use if footers added. Add '#' to remove line.

# --------- page margins:
margin: 2.3 # Sides
bottom: 2 # bottom
top: 2.5 # Top
HardSet_layout: TRUE # Hard-set the spacing of words in your document. This will stop LaTeX squashing text to fit on pages, e.g.
# This is done by hard-setting the spacing dimensions. Set to FALSE if you want LaTeX to optimize this for your paper.

# --------- Line numbers
linenumbers: FALSE # Used when submitting to journal

# ---------- References settings:
# You can download cls format here: https://www.zotero.org/ - simply search for your institution. You can also edit and save cls formats here: https://editor.citationstyles.org/about/
# Hit download, store it in Tex/ folder, and change reference below - easy.
bibliography: Tex/ref.bib       # Do not edit: Keep this naming convention and location.
csl: Tex/harvard-stellenbosch-university.csl # referencing format used.
# By default, the bibliography only displays the cited references. If you want to change this, you can comment out one of the following:
#nocite: '@*' # Add all items in bibliography, whether cited or not
# nocite: |  # add specific references that aren't cited
#  @grinold2000
#  @Someoneelse2010

# ---------- General:
RemovePreprintSubmittedTo: TRUE  # Removes the 'preprint submitted to...' at bottom of titlepage
# Journal: "Journal of Finance"   # Journal that the paper will be submitting to, if RemovePreprintSubmittedTo is set to TRUE.
toc: TRUE                       # Add a table of contents
numbersections: TRUE             # Should sections (and thus figures and tables) be numbered?
fontsize: 11pt                  # Set fontsize
linestretch: 1.2                # Set distance between lines.
link-citations: TRUE            # This creates dynamic links to the papers in reference list.

### Adding additional latex packages:
# header-includes:
#    - \usepackage{colortbl} # Add additional packages here.

output:
  pdf_document:
    keep_tex: FALSE
    template: Tex/TexDefault.txt
    fig_width: 3.5 # Adjust default figure sizes. This can also be done in the chunks of the text.
    fig_height: 3.5
abstract: |
  Abstract to be written here.
---

<!-- First: Default preferences for chunk options: -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 6, fig.height = 5, fig.pos="H", 
                      fig.pos = 'H', purl = TRUE)
library(pacman)

pacman::p_load(tidyverse, dplyr, stargazer, readr, lubridate, bookdown,
               tsDym, urca, tseries, vars, gridExtra, varEst, strucchange, 
               forecast, tidystats) 
fmxdat::source_all("./code")
```


<!-- ############################## -->
<!-- # Start Writing here: -->
<!-- ############################## -->

\newpage

# Part I

# Introduction


The aim of this paper is to replicate the work by @mainpaper. They analyse
the determinants of the Real Effective Exchange Rate (REER) based on a collection
of variables as determinants, using a Vector Error Correction Model. The purpose
of their study was to use the most current research to investigate a set of 
variables with explanatory power in determining the long term behaviour of the 
REER in South Africa. They used the period starting from the first quarter of 
1970 until the first quarter of the year 2002. Towards this end, they made 
use of the Maximum Likelihood method of estimating the VECM, developed in 
@johansenMLE. Their choice of variables is based on the most recent research 
at the time, of the determinants of the real exchange rate in developing 
economies such as South Africa. This paper serves to replicate the steps taken
by @mainpaper and reach a conclusion independently, and thus will critically
evaluate the logical flow towards estimating the final model. Therefore, 
additional tests and evaluations are made to reassess the robustness of the
final mode.

The choice of the model vector introduced later, is based on several 
developments prior to 2004. Briefly, the variables have been found to serve as
feasible explanatory variables for the REER includes: productivity, real 
interest rates relative to mostly traded with, the relative openness of the 
selected economy to trade, and the magnitude of the fiscal balance and net 
foreign assets [@mainpaper].

The Purchasing Power Parity (PPP) points to the equality between the price levels
between two countries if they were quoted in the same currencies. When the PPP
holds, the real exchange rate must not vary [@ppp]. The VECM for the REER is 
thus an attempt to elucidate the nature of deviations from the PPP. A 
comprehensive and accurate model for the deviations from the PPP that is 
explainable by real factors  would provide an appropriate framework for 
policy-makers to respond with ideal policy [@ppp]. In light of this, @mainpaper
attempt to bring various explanatory variables together in a broad model that
can appropriately explain these deviations.




# Part II: Replication {-}



# Importing and Cleaning the Data


```{r, include=F}
full_df <- fetch_full() %>% full_clean()
```


# Plotting the Model Variables (STEP 0.)


Figures \ref{reers} \& \ref{detreers} displays each variable as they as they 
were before their natural logarithm transformation.

```{r echo=FALSE, fig.cap="The South Africa Real Exchange Rate \\label{reers}"}
# p1 <- plot_endog1(full_df)
# p2 <- plot_endog2(df = full_df)
plot_endog1(full_df)
# grid.arrange(p1, p2, nrow=2)
```

_might have to rethink this: The regime changes might be accounted for/proxied_
_by including the openness, real commodity prices and net foreign assets??_

The red lines indicate the dates at which dummy variables for possible outliers
will be included as an alternative model specification. This alternative 
specification aims to account for the large changes in the real exchange rate
regime over the period. There was little consistency in the manner in which
the real exchange rate was determined over the period from 1970 to 2002. Most
significantly, intermittent changes in the degree and nature of intervention
from the South African Reserve Bank (SARB) suggests that the explanatory factors
determining the REER will necessary be inconsistent over this period [@detreer].
The period from 1979 to 1988 from figure \ref{reers} for example, is visually 
unique from the rest of the time series. The coincidence seems unlikely with
some research suggesting that intervention during this period was based on
maintaining the real price of gold in rand [@detreer]. This suggests that a 
model that can account for some structural deviations might be more appropriate.
The VECM developed by @mainpaper to explain the equilibrium deviations of the 
REER might achieve more preciseness by accounting for these periods of deviation
from free market behaviour.

```{r echo=FALSE, fig.cap="Determinants of the Real Exchange Rate for South Africa \\label{detreers}", fig.width=7}
plot_endog2(df = full_df)
```

Figure \ref{detreers} above might also suggest that there is a possible 
structural break in the time series around the year 1985. This is mostly evident
in the behaviour of the variable `NFAOFPY`, the Net Foreign Assets proxy. The 
openness indicator, Relative Real Interest Rate, Relative Real GDP, and Real 
Commodity prices slightly correspond to this theory as well. A test for this is 
therefore necessary.

To illustrate the co-movement of the system, figure \ref{join} below plots them 
jointly. Note that the Openness Indicator has also been logged to make the 
visual comparison easier.

```{r echo=FALSE, fig.cap="The Joint plot of the Model Varibales (Logged where necessary) \\label{joint}"}
plot_endog_joint(df = full_df)
```


A relative degree of co-movement is noticeable in each of these time series 
altogether. The Log of Real GDP, however, requires one to take into account the
declining trend, after which the co-movement seems more evident. Also worth 
noting, is that none of these series seem to be stationary.

# The Johansen Method in Theory

_explain johansen method_

The @johansenMLE method requires six steps in the estimation process, which 
follows as:

1. Choosing a specification for the deterministic parts of the model
2. Pre-testing the variables in the system to ensure that they are likely 
integrated of order one (i.e. $x_t \sim I(1)$$)
3. Estimating the unrestricted Vector Autoregressive model in levels and
checking this models adequacy
4. Estimating the VECM form and determining the cointegration rank (i.e. 'r')
5. etc.


# 0. Plotting the Diffirenced Variables (STEP 1.)


```{r echo=FALSE, fig.cap="The First Difference of the LREERS \\label{reerdiff}"}
diff_df <- full_df %>% mutate(across(names(.)[2:13], function(x) x-lag(x))) %>%
    filter(date > first(date))
plot_endog1_log(diff_df)
```



```{r echo=FALSE, fig.cap="The First Difference of the Determinants of the Real Exchange Rate \\label{DETdiff}"}
plot_endog2_log(df = diff_df)
```

figures \ref{DETdiff} and \ref{reerdiff} above suggest that the REER time series
and its candidate explanatory variables are possibly integrated of the first 
order (i.e. $REER \sim I(1)$). The deterministic component is most likely a 
constant term. Each of these variables seem somewhat stationary after their 
first difference is been determined.

```{r echo=FALSE, fig.cap="The Augmented Dicky-Fuller Test \\label{adf_joint}"}
# adf_temp <- urca::ur.df(full_df[,"LRGDPPCR"], type = "trend", lags = 8, selectlags = "BIC")
# Better format this later
joint_adf_test <- joint_adf(full_df)
# knitr::kable(joint_adf_test)
joint_adf_test
```

The Augmented Dicky-Fuller tests for the differenced time series values of all 
the variables in the system are displayed in figure \ref{adf_diff} below.

```{r echo=FALSE, fig.cap="The Augmented Dicky-Fuller Test \\label{adf_diff_joint}"}
# Better format this later
joint_adf_test <- joint_adf_diff(full_df)
# knitr::kable(joint_adf_test)
joint_adf_test
```

To test this hypothesis, that each of these series are only stationary after the
first difference, the Augmented Dickey Fuller test is employed. The Augmented 
Dicky-Fuller tests for the differenced time series values of all 
the variables in the system, as well as the first difference of each of these 
series are displayed in figures \ref{adf_joint} and \ref{adf_joint_diff} above.
The figures confirm that none of the variables are stationary, and that all but `
NFAOFPY` i.e. the net foreign assets are stationary after the first difference. 
For those that are stationary, the null hypothesis was rejected at the 1% 
significance level, barring the openness indicator for which the p-value is less
than 0.05. This might be due to the large deviations created by the apartheid 
era sanctions [@mainpaper]. 


## VECM Model Estimation in Theory:

*paper table 1 col's:*

*1. Var's + Seasonal(4) + lags(4)*
*2. ^Above^ + outlier_dummies -> Trace test* $\implies$ *two CI vectors*


_Multiple ways to estimate VEC models:_

_First approach: ordinary least squares (yields accurate result) but does not allow to estimate the cointegrating relations among the variables._
_The estimated generalised least squares (EGLS) approach would be an alternative._

_Most popular estimator: MLE of Johansen (1995)_
_[In R: ca.jo function of the urca package of Pfaff (2008a)]_
_Alternatively, `VECM` of tsDyn package of Di Narzo et al. (2020)_

_Before VECM:_
_1. Determine lag order p -> Det. rank of CI matrix r_
_2. deterministic terms have to be specified._
_3. Choose lag order: est. the VAR in levels_
_4. Choose lag specification that minimises an Information criterion_



```{r include=FALSE}
endog_df <- split_data_endog(full_df)
exog_df <- split_data_exog(full_df)
endog_df; exog_df
```


# 1.A: Estimating the Unrestricted VAR in Levels and Checking Adequacy


```{r}
options(scipen=999)
var_aic <- VAR(endog_df[,c(2:8)], type = "const", lag.max = 8, 
               ic = "AIC", season = 4)

VARselect(endog_df[,c(2:8)], type = "const", lag.max = 4, season = 4)$selection
VARselect(endog_df[,c(2:8)], type = "const", lag.max = 4, season = 4,
          exogen = exog_df[,5:8])$selection

var_aic2 <- endog_df %>% dplyr::select(2:8) %>% VAR(., type = "const", season = 4, 
                                             exogen = exog_df[,5:8], 
                                             lag.max = 8, ic = "AIC")
# var_aic3 <- endog_df %>% dplyr::select(2:7 | 9) %>% VAR(., type = "const", season = 4, 
#                                              exogen = exog_df[,5:8], 
#                                              lag.max = 8, ic = "AIC")
# 
# var_aic4 <- endog_df %>% dplyr::select(2:7 | 10) %>% VAR(., type = "const", season = 4, 
#                                              exogen = exog_df[,5:8], 
#                                              lag.max = 8, ic = "AIC")
# 
# var_aic5 <- endog_df %>% dplyr::select(2:7 | 11) %>% VAR(., type = "const", season = 4, 
#                                              exogen = exog_df[,5:8], 
#                                              lag.max = 8, ic = "AIC")
# 
# var_aic6 <- endog_df %>% dplyr::select(2:7 | 12) %>% VAR(., type = "const", season = 4, 
#                                              exogen = exog_df[,5:8], 
#                                              lag.max = 8, ic = "AIC")
# 
# var_aic7 <- endog_df %>% dplyr::select(2:7 | 13) %>% VAR(., type = "const", season = 4, 
#                                              exogen = exog_df[,5:8], 
#                                              lag.max = 8, ic = "AIC")

# var_aic$p; var_aic2$p; var_aic3$p; var_aic4$p; var_aic5$p; var_aic6$p; var_aic7$p
# normality.test(var_aic)

options(scipen=0)
```


```{r results='asis', message=F, comment='%', tidy=T}
stargazer(var_aic2$varresult$LREERS, font.size = "tiny")
```

_Tests to perform:_
_1. Structural break_
_2. White noise residuals_
_3. autocorr resid's_
_4. time-varying params_
_5. heteroskedasticity_


# 1.B: Tests on VAR

## White Noise Residuals

```{r echo=FALSE, fig.cap="VAR Residuals plot - Model 1\\label{resid1}"}
as_tibble(resid(var_aic)) %>% gather(vary, res) %>% 
    dplyr::summarise(index = rep(c(1:127), 7), vary, res) %>%
    group_by(vary) %>% 
    ggplot() +
    geom_line(aes(x = index, y = res, color = vary, linetype = vary)) +
    facet_wrap(~vary, ncol = 2, scales = "free_y") +
    guides(color=FALSE, linetype=FALSE) +
    scale_y_continuous("Residual value")
    # element_text()
```

The plot of the residuals from the first VAR model in figure \ref{resid1} seems
very close to a white noise process, however, there do appear to be deviations
from the zero mean that could imply otherwise. The clusters of larger residuals
appear to be concentrated around the timeline that corresponds with the outliers
identified by @mainpaper. Alternatively, this could add an additional 
illustration of the underlying effect of a structural change in the data.

```{r include=FALSE}
a1 <- checkresiduals(var_aic$varresult$LREERS, test = "LB", plot = F)
a2 <- checkresiduals(var_aic$varresult$RIRR, test = "LB", plot = F)
a3 <- checkresiduals(var_aic$varresult$LRGDPPCR, test = "LB", plot = F)
a4 <- checkresiduals(var_aic$varresult$OPENY, test = "LB", plot = F)
a5 <- checkresiduals(var_aic$varresult$FBYA, test = "LB", plot = F)
a6 <- checkresiduals(var_aic$varresult$NFAOFPY, test = "LB", plot = F)
a7 <- checkresiduals(var_aic$varresult$LPR2COMM5, test = "LB", plot = F)

a1$data.name = "LREERS_Residual"
a2$data.name = "RIRR_Residual"
a3$data.name = "LRGDPPCR_Residual"
a4$data.name = "OPENY_Residual"
a5$data.name = "FBYA_Residual"
a6$data.name = "NFAOFPY_Residual"
a7$data.name = "LPR2COMM5_Residual"

a1 <- unlist(a1)
a2 <- unlist(a2)
a3 <- unlist(a3)
a4 <- unlist(a4)
a5 <- unlist(a5)
a6 <- unlist(a6)
a7 <- unlist(a7)



# a1 <- tidy_stats(a1)

```

```{r results='asis', message=F, comment='%', tidy=T}
stargazer(a1, header = F)
```


_might still plot `acf` of residuals_



## Check for the presence of Structural Break

```{r Testing for Structural Break}

```


# Determining the order of CI

```{r}

vec <- ca.jo(full_df[,2:8], type = "trace", ecdet = "const", spec = "transitory",
             K = 2, season = 4)

vec2 <- full_df %>% dplyr::select(2:8) %>% ca.jo(., type = "trace", 
                                             ecdet = "const", 
                                             spec = "transitory", K = 2, 
                                             season = 4, 
                                             dumvar = exog_df[,5:8])

summary(vec2)
```


<!-- ```{r results='asis', message=F, comment='%', tidy=T} -->

<!-- stargazer(summ_vec, header = FALSE, summary = F) -->

<!-- ``` -->

# Estimating VECM


```{r}
mod1 <- full_df %>% dplyr::select(2:8) %>% 
    tsDyn::VECM(., lag = 4, estim = "ML",
                include = "const", r=1, 
                exogen = exog_df[,2:4])
summary(mod1)
# mod2 <- full_df %>% dplyr::select(2:8) %>% 
#     tsDyn::VECM(., lag = 4, estim = "ML",
#                 include = "const", r=1, 
#                 exogen = exog_df[,2:8])
# summary(mod2)

# mod3 <- full_df %>% dplyr::select(2:7 | 9) %>% 
#     tsDyn::VECM(., lag = 4, estim = "ML",
#                 include = "const", r=1, 
#                 exogen = exog_df[,2:8])
# summary(mod3)

# mod4 <- full_df %>% dplyr::select(2:7 | 10) %>% 
#     tsDyn::VECM(., lag = 4, estim = "ML",
#                 include = "const", r=1, 
#                 exogen = exog_df[,2:8])
# summary(mod4)

# mod5 <- full_df %>% dplyr::select(2:7 | 11) %>% 
#     tsDyn::VECM(., lag = 4, estim = "ML",
#                 include = "const", r=1, 
#                 exogen = exog_df[,2:8])
# summary(mod5)

# mod6 <- full_df %>% dplyr::select(2:7 | 12) %>% 
#     tsDyn::VECM(., lag = 4, estim = "ML",
#                 include = "const", r=1, 
#                 exogen = exog_df[,2:8])
# summary(mod6)

# mod7 <- full_df %>% dplyr::select(2:7 | 13) %>% 
#     tsDyn::VECM(., lag = 4, estim = "ML",
#                 include = "const", r=1, 
#                 exogen = exog_df[,2:8])
# summary(mod7)

```




```{r}

```


# Directly from [@mainpaper]





## Section 3 Data and Methodology

* Plotting the exp(LREER) and the rest of the variables
* Showcase the vector of interest
* Investigate LR CI Rel's amongst var's in vector
    - Method: MLE of @johansenMLE
    - Why? Corrects for Autocorr and ednog parametrically using VECM specif.
    - Key Advantage: the estimated coefficient - the $\beta$ vector - can be used to 
    provide a measure of the equilibrium real exchange rate and therefore a 
    quantification of the gap between the prevailing real exchange rate and 
    its equilibrium level. The methodology also derives estimates of the speed 
    at which the real exchange rates converges to the equilibrium level.


    






# Old Stuff

<!-- ## Log of Real Effective Exchange Rate for SA (LREER) -->

<!-- Importing the `LREER` time series: -->

<!-- ```{r} -->
<!-- # LREER <- lreer_fetch() -->
<!-- # # # check whetther there are any `NA` vales in the dataset -->
<!-- # # LREER %>% select(Value) %>% any(is.na(.)) -->
<!-- # LREER -->
<!-- ``` -->


<!-- cleaning the lreer dataset -->
<!-- ```{r} -->
<!-- # Convert the date column to the correct format -->
<!-- # LREER <- lreer_wrangle_date(LREER) -->
<!-- #  -->
<!-- # # And change the base year from 2015 to 1995 as in the paper -->
<!-- # LREER <-lreer_rebase(LREER) -->
<!-- # LREER -->
<!-- ``` -->



<!-- ## Real Interest Rate Relative to Trading Partners -->

<!-- ```{r} -->
<!-- # RIRR <- rirr_fetch() -->
<!-- # RIRR -->
<!-- ``` -->

\newpage

# References


<div id="refs"></div>

\newpage

# Appendix {-} 

# Introduction

* What did I do?


* why did I do this?


# Literature Review


## What did the Authors do?


## Motivation
* Importance
* Methods
* Novel Contribution(s)


## Critical Evaluation

* Robustness checks/extensions



## Variable Names (SECTION TO BE DELETED)

```{r include=F}
as_tibble(names(full_df))
```